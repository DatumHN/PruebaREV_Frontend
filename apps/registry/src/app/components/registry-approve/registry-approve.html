<!-- Toast para notificaciones -->
<p-toast></p-toast>

<!-- Contenedor principal con Tailwind CSS -->
<div class="tw-bg-gray-100 tw-p-4 md:tw-p-8 tw-min-h-screen">
  <div class="tw-card-rnpn-elevated tw-w-full tw-max-w-7xl tw-mx-auto">
    <!-- Título del componente -->
    <div class="tw-card-rnpn-header">
      <div class="tw-flex tw-justify-between tw-items-center">
        <h1 class="tw-card-rnpn-title tw-text-3xl">
          Revisión de Solicitud de Registro
        </h1>
        <div *ngIf="solicitudId" class="tw-text-right">
          <span class="tw-text-sm tw-text-gray-500">ID Solicitud:</span>
          <span
            class="tw-font-mono tw-bg-gray-200 tw-text-gray-700 tw-rounded tw-px-2 tw-py-1 tw-ml-1"
          >
            {{ solicitudId }}
          </span>
        </div>
      </div>
    </div>

    <div class="tw-card-rnpn-content">
      <!-- Estado de Carga -->
      <div
        *ngIf="isLoading"
        class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-p-16"
      >
        <div class="tw-spinner-with-text">
          <div class="tw-spinner-rnpn-xl"></div>
          <p class="tw-spinner-text tw-text-lg">
            Cargando datos de la solicitud...
          </p>
        </div>
      </div>

      <!-- Estado de Error o Sin Datos -->
      <div *ngIf="!isLoading && noDataMessage" class="tw-text-center tw-p-16">
        <i
          class="pi pi-exclamation-triangle tw-text-yellow-500 tw-text-5xl"
        ></i>
        <p class="tw-mt-4 tw-text-xl tw-text-gray-700">{{ noDataMessage }}</p>
      </div>

      <!-- Stepper y Formulario -->
      <div *ngIf="!isLoading && !noDataMessage && stepsConfig.length > 0">
        <p-stepper
          [(value)]="activeStepIndex"
          [linear]="false"
          class="tw-w-full tw-flex tw-flex-col"
        >
          <!-- Lista de Pasos (Navegación) -->
          <p-step-list class="tw-w-full tw-flex tw-justify-center tw-mb-6">
            <!-- SOLUCIÓN: Cambiado '$index' a 'index' -->
            <ng-container *ngFor="let step of stepsConfig; let i = index">
              <p-step [value]="i">
                <span class="p-stepper-title font-medium"
                  >{{ step.header }}</span
                >
              </p-step>
            </ng-container>
          </p-step-list>

          <!-- Paneles de Contenido de cada Paso -->
          <p-step-panels class="tw-w-full">
            <!-- SOLUCIÓN: Cambiado '$index' a 'index' -->
            <ng-container *ngFor="let step of stepsConfig; let i = index">
              <p-step-panel [value]="i">
                <ng-template pTemplate="content">
                  <div class="tw-flex tw-justify-center tw-p-2 md:tw-p-6">
                    <div class="tw-w-full tw-max-w-5xl">
                      <!-- Renderizar Formulario Dinámico si hay campos -->
                      <div
                        *ngIf="step.formlyFields?.length; else noFieldsTemplate"
                      >
                        <form
                          [formGroup]="getStepFormGroup(step.id)"
                          class="p-fluid"
                        >
                          <formly-form
                            [form]="getStepFormGroup(step.id)"
                            [fields]="step.formlyFields || []"
                            [model]="mainModel[step.id]"
                          >
                          </formly-form>
                        </form>
                      </div>

                      <!-- Plantilla para el último paso o pasos sin campos -->
                      <ng-template #noFieldsTemplate>
                        <div
                          *ngIf="step.id === 'approval_actions'"
                          class="tw-text-center tw-p-8 tw-border-2 tw-border-dashed tw-rounded-lg"
                        >
                          <h3
                            class="tw-text-2xl tw-font-bold tw-text-gray-800 tw-mb-4"
                          >
                            Confirmación Final
                          </h3>
                          <p class="tw-text-gray-600 tw-mb-6">
                            Ha revisado todos los datos de la solicitud. Por
                            favor, seleccione una acción a continuación.
                          </p>
                          <div class="tw-flex tw-justify-center tw-gap-4">
                            <button
                              class="tw-px-6 tw-py-3 tw-text-white tw-bg-red-600 hover:tw-bg-red-700 tw-rounded-md tw-font-medium tw-transition-colors tw-flex tw-items-center tw-gap-2"
                              (click)="submitDecision('Rechazado')"
                            >
                              <i class="pi pi-times"></i>
                              Rechazar Solicitud
                            </button>
                            <button
                              class="tw-px-6 tw-py-3 tw-text-white tw-bg-green-600 hover:tw-bg-green-700 tw-rounded-md tw-font-medium tw-transition-colors tw-flex tw-items-center tw-gap-2"
                              (click)="submitDecision('Aprobado')"
                            >
                              <i class="pi pi-check"></i>
                              Aprobar Solicitud
                            </button>
                          </div>
                        </div>
                        <div
                          *ngIf="step.id !== 'approval_actions'"
                          class="tw-text-center tw-p-8"
                        >
                          <p class="tw-text-gray-500">
                            Esta sección no contiene campos para mostrar.
                          </p>
                        </div>
                      </ng-template>

                      <!-- Botones de Navegación -->
                      <div
                        class="tw-flex tw-pt-6 tw-mt-6 tw-border-t tw-gap-3"
                        [ngClass]="{'tw-justify-end': i === 0, 'tw-justify-between': i > 0}"
                      >
                        <button
                          *ngIf="i > 0"
                          class="tw-btn-rnpn-outline"
                          (click)="prevStep()"
                        >
                          <i class="pi pi-arrow-left tw-mr-2"></i>
                          Anterior
                        </button>

                        <button
                          *ngIf="i < stepsConfig.length - 1"
                          class="tw-btn-rnpn tw-ml-auto"
                          (click)="nextStep()"
                        >
                          Siguiente
                          <i class="pi pi-arrow-right tw-ml-2"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </ng-template>
              </p-step-panel>
            </ng-container>
          </p-step-panels>
        </p-stepper>
      </div>
    </div>
  </div>
</div>
