<!-- ======================================================== -->
<!-- ===          DIÁLOGO PARA BÚSQUEDA DE PERSONA      === -->
<!-- ======================================================== -->
@if (isSearchModalVisible) {
<div
  class="tw-modal-overlay"
  (click)="$event.target === $event.currentTarget && closeSearchModal()"
  (keydown.escape)="closeSearchModal()"
  tabindex="0"
>
  <div
    class="tw-modal-rnpn tw-modal-custom"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="'modal-title-search'"
  >
    <!-- Modal Header -->
    <div class="tw-modal-header">
      <h2 id="modal-title-search" class="tw-modal-title">
        {{ searchModalTitle }}
      </h2>
      <button
        class="tw-modal-close"
        (click)="closeSearchModal()"
        aria-label="Cerrar modal"
      >
        <i class="pi pi-times" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="tw-modal-body">
      @if (isSearching) {
      <!-- Estado de Carga -->
      <div class="tw-modal-loading">
        <i
          class="pi pi-spin pi-spinner tw-modal-loading-spinner"
          aria-hidden="true"
        ></i>
        <p class="tw-modal-loading-text">Buscando...</p>
      </div>
      } @else if (searchError) {
      <!-- Estado de Error -->
      <div class="tw-modal-error">
        <i
          class="pi pi-times-circle tw-modal-error-icon"
          aria-hidden="true"
        ></i>
        <p class="tw-modal-error-text">{{ searchError }}</p>
      </div>
      } @else if (searchResults.length > 0) {
      <!-- Resultados Encontrados -->
      <div>
        <p class="tw-mb-4 tw-text-gray-700">
          Se encontró el siguiente registro. ¿Desea seleccionarlo para
          autocompletar el campo?
        </p>

        @for (result of searchResults; track result.dui) {
        <div
          class="tw-card-rnpn tw-mb-4 hover:tw-shadow-lg tw-transition-shadow tw-duration-300"
        >
          <!-- Card Header -->
          <div class="tw-card-rnpn-header">
            <div class="tw-flex tw-items-center">
              <img
                [src]="result.fotoUrl"
                alt="Foto de {{ result.nombre }}"
                class="tw-w-20 tw-h-20 tw-rounded-full tw-mr-4 tw-object-cover tw-border-2 tw-border-gray-200"
                onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto';"
              />
              <div>
                <h3 class="tw-card-rnpn-title">{{ result.nombre }}</h3>
                <p class="tw-card-rnpn-subtitle">DUI: {{ result.dui }}</p>
              </div>
            </div>
          </div>

          <!-- Card Content -->
          <div class="tw-card-rnpn-content">
            <p class="tw-text-gray-700">
              <i class="pi pi-map-marker tw-mr-2" aria-hidden="true"></i>{{
              result.direccion }}
            </p>
          </div>

          <!-- Card Footer -->
          <div class="tw-card-rnpn-footer">
            <div class="tw-flex tw-justify-end">
              <button class="tw-btn-rnpn" (click)="selectSearchResult(result)">
                <i class="pi pi-check tw-mr-2" aria-hidden="true"></i>
                Seleccionar esta persona
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}

<!-- ======================================================== -->
<!-- ===       DIÁLOGO PARA GESTIÓN DE ANEXOS (SOLUCIÓN)  === -->
<!-- ======================================================== -->
@if (isAnexoModalVisible) {
<div
  class="tw-modal-overlay"
  (click)="$event.target === $event.currentTarget && onAnexoModalHide()"
  (keydown.escape)="onAnexoModalHide()"
  tabindex="0"
>
  <div
    class="tw-modal-rnpn tw-modal-anexo"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="'modal-title-anexo'"
  >
    <!-- Modal Header -->
    <div class="tw-modal-header">
      <h2 id="modal-title-anexo" class="tw-modal-title">Agregar Nuevo Anexo</h2>
      <button
        class="tw-modal-close"
        (click)="onAnexoModalHide()"
        aria-label="Cerrar modal"
      >
        <i class="pi pi-times" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="tw-modal-body">
      <form [formGroup]="anexoForm" class="tw-flex tw-flex-col tw-gap-4">
        <!-- Campo: Nombre Predefinido -->
        <div class="tw-flex tw-flex-col tw-gap-2">
          <label
            for="nombrePredefinido"
            class="tw-font-semibold tw-text-gray-900"
          >
            Seleccionar nombre predefinido
          </label>
          <!-- Custom Autocomplete Component -->
          <div class="tw-autocomplete-rnpn" #autocompleteContainer>
            <div class="tw-autocomplete-group">
              <input
                type="text"
                id="nombrePredefinido"
                class="tw-autocomplete-input"
                formControlName="nombrePredefinido"
                placeholder="Ej: Constancia Médica de Nacimiento"
                (input)="onAutocompleteInput($event)"
                (focus)="onAutocompleteFocus()"
                (blur)="onAutocompleteBlur()"
                (keydown)="onAutocompleteKeydown($event)"
                [attr.aria-expanded]="isAutocompleteOpen"
                [attr.aria-haspopup]="true"
                [attr.aria-activedescendant]="highlightedOptionId"
                [attr.aria-controls]="autocompleteListId"
                role="combobox"
                autocomplete="off"
              />
              <button
                type="button"
                class="tw-autocomplete-dropdown"
                [class.active]="isAutocompleteOpen"
                (click)="toggleAutocompleteDropdown()"
                [attr.aria-label]="isAutocompleteOpen ? 'Cerrar lista' : 'Abrir lista'"
              >
                <i
                  class="pi"
                  [class.pi-chevron-up]="isAutocompleteOpen"
                  [class.pi-chevron-down]="!isAutocompleteOpen"
                  aria-hidden="true"
                ></i>
              </button>
            </div>

            <div
              class="tw-autocomplete-panel"
              [class.hidden]="!isAutocompleteOpen"
              role="listbox"
              [attr.id]="autocompleteListId"
            >
              <div class="tw-autocomplete-list">
                @if (isAutocompleteLoading) {
                <div
                  class="tw-autocomplete-loading"
                  role="status"
                  aria-live="polite"
                >
                  Buscando...
                </div>
                } @if (!isAutocompleteLoading && filteredSugerencias.length ===
                0 && autocompleteQuery.length > 0) {
                <div
                  class="tw-autocomplete-empty"
                  role="status"
                  aria-live="polite"
                >
                  No se encontraron resultados para "{{ autocompleteQuery }}"
                </div>
                } @if (!isAutocompleteLoading && filteredSugerencias.length > 0)
                { @for (suggestion of filteredSugerencias; track $index; let i =
                $index) {
                <div
                  class="tw-autocomplete-item"
                  [class.highlighted]="highlightedIndex === i"
                  [attr.id]="getOptionId(i)"
                  (mousedown)="selectAutocompleteSuggestion(suggestion, i)"
                  (mouseenter)="highlightedIndex = i"
                  (keydown.enter)="selectAutocompleteSuggestion(suggestion, i)"
                  (keydown.space)="selectAutocompleteSuggestion(suggestion, i); $event.preventDefault()"
                  tabindex="0"
                  role="option"
                  [attr.aria-selected]="anexoForm.value.nombrePredefinido === suggestion"
                >
                  {{ suggestion }}
                </div>
                } }
              </div>
            </div>
          </div>
        </div>

        <!-- Campo: Nombre Personalizado -->
        <div class="tw-flex tw-flex-col tw-gap-2">
          <label
            for="nombrePersonalizado"
            class="tw-font-semibold tw-text-gray-900"
          >
            O escribir un nombre personalizado
          </label>
          <input
            pInputText
            id="nombrePersonalizado"
            formControlName="nombrePersonalizado"
            placeholder="Ej: DUI de la madre"
            class="tw-w-full"
          />
        </div>

        <!-- Mensaje de error para los nombres -->
        @if (anexoForm.hasError('requireOne') && (anexoForm.touched ||
        anexoForm.dirty)) {
        <app-tailwind-message
          severity="error"
          text="Debe seleccionar un nombre predefinido o escribir uno personalizado."
        ></app-tailwind-message>
        }

        <!-- Campo: Carga de Archivo -->
        <div class="tw-flex tw-flex-col tw-gap-2">
          <label for="anexoFile" class="tw-font-semibold tw-text-gray-900">
            Seleccionar archivo PDF
          </label>
          <!-- Custom Dropzone Component -->
          <div
            class="tw-dropzone-rnpn"
            [class.dragover]="isDragOver"
            [class.error]="anexoForm.get('archivo')?.hasError('required') && anexoForm.get('archivo')?.touched"
            (click)="onDropzoneClick($event)"
            (keydown.enter)="triggerFileInput()"
            (keydown.space)="triggerFileInput(); $event.preventDefault()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            tabindex="0"
            role="button"
            [attr.aria-label]="'Seleccionar archivo PDF. Arrastre y suelte o presione Enter para seleccionar'"
          >
            <input
              #fileInput
              type="file"
              class="tw-dropzone-input"
              accept="application/pdf"
              (change)="onFileInputChange($event)"
              id="anexoFile"
            />

            @if (!selectedFile) {
            <i
              class="pi pi-cloud-upload tw-dropzone-icon"
              aria-hidden="true"
            ></i>
            <div class="tw-dropzone-text">
              Arrastre y suelte un archivo PDF aquí
            </div>
            <div class="tw-dropzone-subtext">
              o haga clic para seleccionar un archivo
            </div>
            <div class="tw-dropzone-subtext">Tamaño máximo: 10MB</div>
            } @if (selectedFile) {
            <div class="tw-dropzone-preview">
              <div class="tw-file-item">
                <div class="tw-file-info">
                  <i class="pi pi-file-pdf tw-file-icon" aria-hidden="true"></i>
                  <div class="tw-file-details">
                    <div class="tw-file-name">{{ selectedFile.name }}</div>
                    <div class="tw-file-size">
                      {{ formatFileSize(selectedFile.size) }}
                    </div>
                  </div>
                </div>
                <div class="tw-file-actions">
                  <button
                    type="button"
                    class="tw-file-remove"
                    (click)="removeFile($event)"
                    title="Eliminar archivo"
                  >
                    <i class="pi pi-times" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
            </div>
            }
          </div>
          @if (anexoForm.get('archivo')?.hasError('required') &&
          anexoForm.get('archivo')?.touched) {
          <app-tailwind-message
            severity="error"
            text="Debe seleccionar un archivo PDF."
          ></app-tailwind-message>
          }
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="tw-modal-footer">
      <button class="tw-btn-rnpn-outline" (click)="closeAnexoModal()">
        <i class="pi pi-times tw-mr-2" aria-hidden="true"></i>
        Cancelar
      </button>
      <button
        class="tw-btn-rnpn"
        (click)="guardarAnexo()"
        [disabled]="anexoForm.invalid"
      >
        <i class="pi pi-check tw-mr-2" aria-hidden="true"></i>
        Guardar Anexo
      </button>
    </div>
  </div>
</div>
}

<!-- ======================================================== -->
<!-- ===          CONTENIDO PRINCIPAL DEL FORMULARIO      === -->
<!-- ======================================================== -->
<div class="">
  <div
    class="tw-card-rnpn-elevated tw-w-full tw-max-w-7xl tw-mx-auto tw-bg-white"
  >
    <div class="tw-card-rnpn-header tw-text-center">
      <h1 class="tw-card-rnpn-title tw-text-3xl tw-mb-4">
        Solicitud de Registro de {{ currentRegistryTypeName }}
      </h1>
    </div>

    <div class="tw-card-rnpn-content">
      <div
        class="tw-w-full tw-max-w-5xl tw-mx-auto tw-p-6 tw-mb-8 tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-sm tw-bg-white"
      >
        <form [formGroup]="topForm" class="p-fluid">
          <formly-form
            [form]="topForm"
            [fields]="topFields"
            [model]="topModel"
          ></formly-form>
        </form>
      </div>

      @if (isLoading) {
      <div
        class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-p-16"
      >
        <div class="tw-spinner-with-text">
          <div class="tw-spinner-rnpn-xl"></div>
          <p class="tw-spinner-text tw-text-lg">
            Cargando datos de la solicitud...
          </p>
        </div>
      </div>
      } @else if (!isLoading && stepsConfig.length > 0) {
      <div class="tw-w-full tw-flex tw-flex-col tw-items-center">
        <app-tailwind-stepper
          [activeStepIndex]="activeStepIndex"
          [steps]="stepsConfig"
          [linear]="false"
          (stepChange)="onStepChange($event)"
          class="tw-w-full tw-max-w-6xl tw-flex tw-flex-col"
        >
          <!-- Step Content -->
          <div class="tw-w-full">
            @if (activeStepIndex < stepsConfig.length) { @let step =
            stepsConfig[activeStepIndex];
            <div class="tw-flex tw-justify-center tw-p-2 md:tw-p-6">
              <div class="tw-w-full">
                @if (!isLoading && step.formlyFields?.length) {
                <form [formGroup]="getStepFormGroup(step.id)" class="p-fluid">
                  <formly-form
                    [form]="getStepFormGroup(step.id)"
                    [fields]="step.formlyFields || []"
                    [model]="mainModel[step.id]"
                  >
                  </formly-form>
                </form>
                } @else if (step.id === 'completion') {
                <div>
                  <div
                    class="tw-flex tw-justify-center tw-gap-8 tw-flex-wrap tw-mb-8"
                  >
                    <div class="tw-card-rnpn tw-w-full tw-max-w-md">
                      <div class="tw-card-rnpn-content">
                        <app-logo-selector
                          [selectedLogo]="selectedLogo"
                          (logoSelected)="onLogoSelected($event)"
                          (logoBase64Changed)="onLogoBase64Changed($event)"
                        ></app-logo-selector>
                      </div>
                    </div>
                    <div
                      class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-w-full tw-max-w-md"
                    >
                      <button
                        class="tw-btn-rnpn tw-w-full tw-mb-3"
                        (click)="showPdfWithDynamicData()"
                      >
                        <i class="pi pi-eye tw-mr-2"></i>
                        Visualizar Solicitud
                      </button>
                    </div>
                  </div>

                  <p-divider align="center" styleClass="my-8">
                    <span class="tw-font-bold tw-text-lg"
                      >Gestión de Anexos</span
                    >
                  </p-divider>

                  <div
                    class="tw-grid tw-grid-cols-1 lg:tw-grid-cols-2 tw-gap-8"
                  >
                    <div class="tw-card-rnpn">
                      <div class="tw-card-rnpn-header">
                        <h3 class="tw-card-rnpn-title">Anexos Subidos</h3>
                      </div>
                      <div class="tw-card-rnpn-content">
                        <div class="tw-flex tw-justify-end tw-mb-4">
                          <button
                            class="tw-btn-rnpn"
                            (click)="openAnexoModal()"
                          >
                            <i class="pi pi-plus tw-mr-2"></i>
                            Agregar Anexo
                          </button>
                        </div>
                        <!-- Custom Tailwind Table -->
                        <div
                          class="tw-overflow-hidden tw-shadow tw-ring-1 tw-ring-black tw-ring-opacity-5 tw-rounded-lg"
                        >
                          <table
                            class="tw-min-w-full tw-divide-y tw-divide-gray-300"
                          >
                            <thead class="tw-bg-gray-50">
                              <tr>
                                <th
                                  scope="col"
                                  class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider"
                                >
                                  Nombre del Anexo
                                </th>
                                <th
                                  scope="col"
                                  class="tw-px-6 tw-py-3 tw-text-center tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider tw-w-32"
                                >
                                  Acciones
                                </th>
                              </tr>
                            </thead>
                            <tbody
                              class="tw-bg-white tw-divide-y tw-divide-gray-200"
                            >
                              @if (anexosSubidos.length === 0) {
                              <!-- Empty state -->
                              <tr>
                                <td
                                  colspan="2"
                                  class="tw-px-6 tw-py-8 tw-text-center tw-text-sm tw-text-gray-500"
                                >
                                  <svg
                                    class="tw-mx-auto tw-h-12 tw-w-12 tw-text-gray-400 tw-mb-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                    />
                                  </svg>
                                  <p class="tw-font-medium">
                                    Aún no se han subido anexos.
                                  </p>
                                  <p class="tw-text-gray-400">
                                    Los anexos aparecerán aquí una vez que los
                                    agregue.
                                  </p>
                                </td>
                              </tr>
                              } @else { @for (anexo of anexosSubidos; track
                              $index; let rowIndex = $index) {
                              <tr
                                class="tw-hover:tw-bg-gray-50 tw-transition-colors"
                              >
                                <td
                                  class="tw-px-6 tw-py-4 tw-whitespace-nowrap"
                                >
                                  <div class="tw-flex tw-items-center">
                                    <div
                                      class="tw-flex-shrink-0 tw-h-10 tw-w-10"
                                    >
                                      <div
                                        class="tw-h-10 tw-w-10 tw-rounded-full tw-bg-red-100 tw-flex tw-items-center tw-justify-center"
                                      >
                                        <svg
                                          class="tw-h-6 tw-w-6 tw-text-red-600"
                                          fill="none"
                                          viewBox="0 0 24 24"
                                          stroke="currentColor"
                                        >
                                          <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                          />
                                        </svg>
                                      </div>
                                    </div>
                                    <div class="tw-ml-4">
                                      <div
                                        class="tw-text-sm tw-font-medium tw-text-gray-900"
                                      >
                                        {{ anexo.nombre }}
                                      </div>
                                      <div class="tw-text-sm tw-text-gray-500">
                                        {{ anexo.archivo.name }} ({{
                                        (anexo.archivo.size / 1024) |
                                        number:'1.0-2' }} KB)
                                      </div>
                                    </div>
                                  </div>
                                </td>
                                <td
                                  class="tw-px-6 tw-py-4 tw-whitespace-nowrap tw-text-center tw-text-sm tw-font-medium"
                                >
                                  <button
                                    type="button"
                                    class="tw-inline-flex tw-items-center tw-p-1.5 tw-border tw-border-transparent tw-rounded-full tw-shadow-sm tw-text-red-600 tw-bg-red-100 hover:tw-bg-red-200 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-red-500 tw-transition-colors"
                                    (click)="eliminarAnexo(rowIndex)"
                                    title="Eliminar anexo"
                                  >
                                    <svg
                                      class="tw-h-4 tw-w-4"
                                      fill="none"
                                      viewBox="0 0 24 24"
                                      stroke="currentColor"
                                    >
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                      />
                                    </svg>
                                    <span class="tw-sr-only"
                                      >Eliminar anexo</span
                                    >
                                  </button>
                                </td>
                              </tr>
                              } }
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <div class="tw-card-rnpn">
                      <div class="tw-card-rnpn-header">
                        <h3 class="tw-card-rnpn-title">
                          Anexos Esperados (Requeridos)
                        </h3>
                      </div>
                      <div class="tw-card-rnpn-content">
                        <ul
                          class="tw-list-disc tw-pl-5 tw-space-y-2 tw-text-gray-700"
                        >
                          @for (anexo of anexosEsperados; track anexo.nombre) {
                          <li>{{ anexo.nombre }}</li>
                          }
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                }

                <div
                  class="tw-flex tw-pt-6 tw-mt-6 tw-border-t tw-gap-3"
                  [ngClass]="{'justify-end': activeStepIndex === 0, 'justify-between': activeStepIndex > 0}"
                >
                  @if (activeStepIndex > 0) {
                  <button class="tw-btn-rnpn-outline" (click)="prevStep()">
                    <i class="pi pi-arrow-left tw-mr-2"></i>
                    Anterior
                  </button>
                  }

                  <div
                    class="tw-flex tw-gap-2 tw-ml-auto"
                    [ngClass]="{'ml-0': activeStepIndex === 0}"
                  >
                    @if (step.formlyFields?.length && step.id !== 'completion')
                    {
                    <button
                      class="tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-text-blue-700 tw-bg-blue-50 tw-border tw-border-blue-300 tw-rounded-md hover:tw-bg-blue-100 tw-transition-colors"
                      (click)="fillStepWithTestData(step.id)"
                    >
                      <i class="pi pi-file-edit tw-mr-2"></i>
                      Llenar con datos de ejemplo
                    </button>
                    } @if (activeStepIndex < stepsConfig.length - 1) {
                    <button
                      class="tw-btn-rnpn"
                      (click)="nextStep(activeStepIndex)"
                    >
                      Siguiente
                      <i class="pi pi-arrow-right tw-ml-2"></i>
                    </button>
                    } @if (activeStepIndex === stepsConfig.length - 1) {
                    <button
                      class="tw-btn-rnpn"
                      (click)="submitForm()"
                      [disabled]="isSubmitting"
                    >
                      <i class="pi pi-send tw-mr-2" *ngIf="!isSubmitting"></i>
                      <i
                        class="pi pi-spin pi-spinner tw-mr-2"
                        *ngIf="isSubmitting"
                      ></i>
                      Enviar Solicitud
                    </button>
                    }
                  </div>
                </div>
              </div>
            </div>
            }
          </div>
        </app-tailwind-stepper>
      </div>
      } @else if (!isLoading && stepsConfig.length === 0 && !noDataMessage) {
      <div class="tw-text-center tw-p-8">
        <p class="tw-text-gray-500">
          Por favor, complete las selecciones superiores para cargar el
          formulario de registro.
        </p>
      </div>
      }
    </div>
  </div>
</div>

<app-tailwind-toast-container></app-tailwind-toast-container>
